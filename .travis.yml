language: java
jdk:
  - openjdk8
services:
  - docker
matrix:
  fast_finish: true

env:
  global:
    # DOCKER_USER
    - secure: "CSGFK5aUEWE6g/jSUlqbCSjrYl92Aba9Apmpp47XPSt5+m5sa0/RjnbXO73Za/dElonnrFZc0F6yEo8iqFjjxPz9ZgZD2YHfFWTLubIOvgV2wnN55I6kBUWNT1bqejerrogMSS4x266mufljSaWNWb9Equ4yPP7SlGHH7dpkM9brnNrFxgCK/iwaIECKTCNnxRFKVBHkgdoMtC6D+FOT4VvNKvc6poMdASIC2tPWhDQebmOkGR+rxPLAx8/g3Ck9bauJJ3CMLdTCIKvv8IetzCjwDDk3WwS/hEl0AYdJdLUH+aaTWKX8fgDaXhP9kRh9g24kBi7qWyfuFHFHeiJlqLKuNnVKJiV+GrWUfwfLA6AQG7qHU9Oo+NLmyXgnImgC8r67EuoYMnmSqfFg33Ay33943Qyy3K+6FlrFKpsmvF+aJQwelPsGq+A87ORff5+1+t3Rx3NZDwsRIwtjGxppZhuLrq0KuMvwMC/jYd4mvPEX9/XG4ni76MynrbIYKuzjpFyUwa0nrZw4ln6ReJ3kKkHu4DuFqiuF9RtsfEX7WOGUkYpUjPE9mnRPqfW7TKR5ICmg245X/h0RS7aoqnz8Yy1ZMjFqbhuqj3Fjv2lGxZ11H0KWmb1lxuUSnLKxK2xZsFimERAYO8QVRT6giPfojMiprm4KGT3yDMHiJMUs1JI="
    # DOCKER_PASSWORD
    - secure: "ECCwOmjJucM58CK6yHbYooA2kGhGhw9dNyzC9FOLdShrLQeveHPH7WKn+YZSBaAJRMffMmoPGaZ2ARSVCJ+HCxwLF2q6zv4NKXmxCooC1nZ2JYKEIbmQYOaVrnF51+manEIEAtNHnAEcGsy7lQwjjY/X0Qcax995sIrh3ZWL+Nss0JmSxPmEAPv0IU/tV+8b4dTa4+UbBzXTsz9HgJrNg1FRZcrHPSKhN8KhE5QTg2IBki/7whxMB1bBH5dORQ15XinBgJIGETBu9haBQKrWwhrhhZ8W0FziaNJjIeX9f0lYMrOIxlPxtG6zWea+flR0gpLeL863dc8WwiwHOqAcb2OjiaIEYvCsNmvU8mDIi90saBhEmTCdLAYPF1zstyDOGv9BikfWi7qPxgP7lM8PHu8SuUfZD4OgSlteM9GMZxxJTqgnRlB7kPTA3sD2uK3yHtAO740whbeLOBwRh/6aUTQbaSzDyNFKyXTuJTD5oJFTjkZU3telSECaMpz8j4neFPdROE77Ph9qDXnYUGxg1nj4yINwsCFGIkNsBJjmebu1ldzIT0mYL0KLX5rInR9ygzZf1uBNLcE6N+XIXppRrlRRqO8LliECmWfPyicHE7BiTEjqro8EBUYqCX9GecUuHq0SG+4FLIVGvNAlygr93ldiHnbyMcqEPzix8NTAh3g="
    - IMAGE_NAME=joachimprinzbach/kloud-assistant

before_install:
  - chmod +x gradlew

script:
  - ./gradlew build
  - export BRANCH=$(if [ "$TRAVIS_PULL_REQUEST" == "false" ]; then echo $TRAVIS_BRANCH; else echo $TRAVIS_PULL_REQUEST_BRANCH; fi)
  - export TAG=$(if [ ! -z "$TRAVIS_TAG" ]; then echo "$TRAVIS_TAG"; else echo "$BRANCH-$COMMIT"; fi | sed 's/\//-/')
  - docker build . -t $IMAGE_NAME:latest
  - if [ $BRANCH = "master" ]; then docker tag $IMAGE_NAME:latest $IMAGE_NAME:master; fi
  - docker tag $IMAGE_NAME:latest $IMAGE_NAME:$TAG
  - docker login -u $DOCKER_USER -p $DOCKER_PASSWORD
  - docker push $IMAGE_NAME:latest
  - if [ $BRANCH = "master" ]; then docker push $IMAGE_NAME:master; fi
  - docker push $IMAGE_NAME:$TAG

cache:
  directories:
    - '$HOME/.m2/repository'